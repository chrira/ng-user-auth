/**
 * ng-user-auth 1.0.0
 * (c) 2015 Puzzle ITC
 * License: Apache-2.0
 */
!function(){"use strict";function e(){function e(e,u,c,a,f){function g(){return c.get("$http")}function h(){u.forEach(i,function(e){e(c)});var e=f.path(),n=d(e);!(e.indexOf(t)<0)||n&&n.data&&n.data.anonymousAccessAllowed||f.url(t+"?"+r+"="+e)}function d(e){var n=c.get("$state").get(),t=u.findIndex(n,function(n){return n.url===e});return n[t]}function l(){var e=E();return!!e&&u.isString(e)}function A(e){return S=g().post(n,e).then(P)}function m(){return g()["delete"](n).then(function(){y()})}function v(){return n}function U(){return o}function $(){return s}function p(){return S||(S=g().get(n).then(P)),S}function P(n){var t=n.data;return t.token&&(I=t.token,a.set(k,I),e.$broadcast(T,!0)),e.$broadcast(N,t),t}function E(){return I&&!u.isEmpty(I)&&u.isString(I)||(I=a.get(k),I&&e.$broadcast(T,!0)),I}function y(){I=null,a.remove(k),e.$broadcast(T,!1),e.$broadcast(N,{user:null,permissions:[]}),S=null}var I,S,N="ngUserAuth:userPermissionsChanged",T="ngUserAuth:userLoginStateChanged",k="user.token",L={isLoggedIn:l,login:A,logout:m,getApiEndpoint:v,getAbortRequestsUrlPrefix:U,getDefaultLoggedInPermissionName:$,getUserToken:E,clearUserToken:y,getUserAuthInfo:p,goToLoginScreen:h,AUTH_INFO_CHANGED_EVENT_NAME:N,LOGIN_STATE_CHANGED_EVENT_NAME:T};return L}e.$inject=["$rootScope","lodash","$injector","localStorageService","$location"];var n="/authentication",t="/unauthorized",r="requestedPath",o="/",i=[],s="token_read";this.setApiEndpoint=function(e){n=e},this.setUnauthorizedUrl=function(e){t=e},this.setRequestedPathParameterName=function(e){r=e},this.setAbortRequestsUrlPrefix=function(e){o=e},this.addLogoutAction=function(e){i.push(e)},this.setDefaultLoggedInPermissionName=function(e){s=e},this.$get=e}angular.module("ngUserAuth.service",["ngLodash","LocalStorageModule"]).provider("ngUserAuthService",e)}(),function(){"use strict";function e(e,n){function t(e){e=e||{};var t=n.getAbortRequestsUrlPrefix();t&&e.url.indexOf(t)<0&&(e.noCancelOnRouteChange=!0),void 0!==e.timeout||e.noCancelOnRouteChange||(e.$timeout=i(),e.timeout=e.$timeout.promise);var r=n.getUserToken();return r&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+r),e}function r(e){return s(e.config),e}function o(t){return t.config.timeout.isGloballyCancelled?e.defer().promise:(s(t.config),401===t.status?(u(),n.clearUserToken(),n.goToLoginScreen()):403===t.status&&(t.hasNoAccess=!0),e.reject(t))}function i(){var n=e.defer();return c.push(n),n}function s(e){if(e&&e.$timeout){var n=c.indexOf(e.$timeout);n>=0&&c.splice(n,1)}}function u(){angular.forEach(c,function(e){e.promise.isGloballyCancelled=!0,e.resolve()}),c.length=0}var c=[],a={request:t,response:r,responseError:o};return a}e.$inject=["$q","ngUserAuthService"],angular.module("ngUserAuth.interceptor",["ngUserAuth.service"]).factory("ngUserAuthInterceptor",e)}(),function(){"use strict";function e(e,n,t,r){function o(){$=n.isLoggedIn(),t.$on(n.LOGIN_STATE_CHANGED_EVENT_NAME,function(e,n){$=n}),E=e.defer(),y=!1,n.getUserAuthInfo().then(f,g),i(f)}function i(e){t.$on(n.AUTH_INFO_CHANGED_EVENT_NAME,function(n,t){e(t)})}function s(){return $}function u(){return E.promise}function c(){return y}function a(){return p}function f(e){E.resolve(),y=!0,p=e.user,P=e.permissions}function g(e){E.reject(e),y=!0}function h(e){var n=v(e);return 0===n.length?!0:A(n)}function d(e){var n=v(e);return 0===n.length?!0:m(n)}function l(e){var n=v(e);return 0===n.length?!0:!m(n)}function A(e){return r.every(e,function(e){return r.includes(P,e)})}function m(e){return r.some(e,function(e){return r.includes(P,e)})}function v(e){return void 0===e||r.isEmpty(e)?[]:r.isArray(e)?e:[e]}function U(e,n,t){var r=!0;return h(e)||(r=!1),d(n)||(r=!1),l(t)||(r=!1),r}var $,p,P,E,y,I={notifyOnAuthChange:i,isLoggedIn:s,isReady:c,whenReady:u,getUser:a,userHasPermission:h,userHasAnyPermission:d,userLacksPermission:l,checkPermissions:U};return o(),I}e.$inject=["$q","ngUserAuthService","$rootScope","lodash"],angular.module("ngUserAuthInfo.service",["ngUserAuth.service","ngLodash"]).factory("ngUserAuthInfoService",e)}(),function(){"use strict";function e(e,n,t,r,o){function i(e,n,i){if(!n.data||!n.data.anonymousAccessAllowed){var u=s(n);u.needsCheck&&(r.whenReady().then(function(){var s=r.checkPermissions(u.hasPermission,u.hasAnyPermission,u.lacksPermission);r.isLoggedIn()?s?e.defaultPrevented&&o.go(n.name,i):c(u.redirectTo,i):t.goToLoginScreen()},function(){c(u.redirectTo,i)}),r.isReady()&&r.isLoggedIn()||e.preventDefault())}}function s(e){var n,r,o,i=[];return e.data&&(i=u(e.data.hasPermission),n=e.data.hasAnyPermission,r=e.data.lacksPermission,o=e.data.redirectTo),e&&e.data&&e.data.anonymousAccessAllowed||i.push(t.getDefaultLoggedInPermissionName()),{hasPermission:i,hasAnyPermission:n,lacksPermission:r,redirectTo:o,needsCheck:i.length>0||n||r}}function u(e){return e?n.isArray(e)?e:[e]:[]}function c(e,n){return e?(angular.isFunction(e)&&(e=e()),o.go(e,n)):o.go("forbidden",n)}e.$on("$stateChangeStart",i)}e.$inject=["$rootScope","lodash","ngUserAuthService","ngUserAuthInfoService","$state"],angular.module("ngUserAuth.run",["ngLodash","ngUserAuth.service","ngUserAuthInfo.service","ui.router"]).run(e)}(),function(){"use strict";angular.module("ngUserAuth",["ngUserAuth.config","ngUserAuth.directive","ngUserAuth.interceptor","ngUserAuth.run","ngUserAuth.service","ngUserAuthInfo.service"])}(),function(){"use strict";function e(e,n){function t(t,r,o){function i(){n.checkPermissions(u,c,a)?r.show():r.hide()}var s=e.$new(!0),u=s.$eval(o.hasPermission)||o.hasPermission,c=s.$eval(o.hasAnyPermission)||o.hasAnyPermission,a=s.$eval(o.lacksPermission)||o.lacksPermission;i(),n.notifyOnAuthChange(i)}var r={link:t};return r}e.$inject=["$rootScope","ngUserAuthInfoService"],angular.module("ngUserAuth.directive",["ngUserAuthInfo.service"]).directive("ngUserAuth",e)}(),function(){"use strict";function e(e){e.interceptors.push("ngUserAuthInterceptor")}e.$inject=["$httpProvider"],angular.module("ngUserAuth.config",[]).config(e)}();